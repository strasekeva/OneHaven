name: CI - Tests, Build, Docker, Deploy

on:
  push:
    branches: ["main", "production"]
  pull_request:

jobs:
  backend-tests:
    name: Backend tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./oneHavenProject/backend

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js (backend) + cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: oneHavenProject/backend/package-lock.json

      - name: Install backend dependencies
        run: npm ci

      - name: Run backend tests with coverage
        env:
          NODE_ENV: test
        run: npm test -- --coverage

      - name: Upload backend coverage report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: oneHavenProject/backend/coverage

  frontend-tests:
    name: Frontend tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./oneHavenProject/frontend

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js (frontend) + cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: oneHavenProject/frontend/package-lock.json

      - name: Install frontend dependencies
        run: npm ci

      - name: Run frontend tests with coverage
        env:
          CI: false
        run: npm test -- --watch=false --coverage

      - name: Upload frontend coverage report
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: oneHavenProject/frontend/coverage

  build:
    name: Build (Frontend + Backend artifacts)
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # -------- FRONTEND BUILD --------
      - name: Setup Node.js (frontend) + cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: oneHavenProject/frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./oneHavenProject/frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./oneHavenProject/frontend
        env:
          CI: false
        run: npm run build

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: oneHavenProject/frontend/build

      # -------- BACKEND "BUILD" ARTEFAKT --------
      - name: Create backend build artifact (package)
        run: |
          mkdir -p artifacts
          tar -czf artifacts/backend-build.tar.gz -C oneHavenProject/backend .

      - name: Upload backend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: artifacts/backend-build.tar.gz

  docker-dev:
    name: Docker build & push (dev)
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref_name == 'main'
    environment: Development

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend Docker image (dev)
        uses: docker/build-push-action@v6
        with:
          context: oneHavenProject/backend
          file: oneHavenProject/backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/onehaven-backend:dev
            ${{ secrets.DOCKER_USERNAME }}/onehaven-backend:dev-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  docker-prod:
    name: Docker build & push (prod)
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref_name == 'production'
    environment: Production

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend Docker image (prod)
        uses: docker/build-push-action@v6
        with:
          context: oneHavenProject/backend
          file: oneHavenProject/backend/Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/onehaven-backend:prod
            ${{ secrets.DOCKER_USERNAME }}/onehaven-backend:prod-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-backend-render:
    name: Deploy backend to Render (prod)
    runs-on: ubuntu-latest
    needs: [docker-prod]
    if: github.event_name == 'push' && github.ref_name == 'production'
    environment: Production

    steps:
      - name: Trigger Render deploy hook
        run: curl -fsSL -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"

  deploy-frontend:
    name: Deploy frontend to Firebase Hosting
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref_name == 'main'

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js (frontend) + cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: oneHavenProject/frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: ./oneHavenProject/frontend
        run: npm ci

      - name: Build frontend
        working-directory: ./oneHavenProject/frontend
        env:
          CI: false
        run: npm run build

      - name: Install Firebase CLI
        run: npm i -g firebase-tools

      - name: Deploy to Firebase Hosting
        working-directory: ./oneHavenProject/frontend
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: firebase deploy --only hosting

  deploy-pages:
    name: Deploy project page to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref_name == 'main'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4