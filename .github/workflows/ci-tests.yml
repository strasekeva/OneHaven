name: CI - Tests, Build, Docker, Deploy

on:
  push:
    branches: ["main", "production"]
  pull_request:

# Optimizacija: prekliči stare rune istega PR/brancha
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Datadog global env (uporabi povsod)
env:
  # datadog-ci pričakuje ta imena
  DATADOG_API_KEY: ${{ secrets.DD_API_KEY }}
  DATADOG_SITE: ${{ secrets.DD_SITE }} # datadoghq.eu ali datadoghq.com

  # (opcijsko) dodatni kontekst (uporaben za filtre v Datadogu)
  DD_SERVICE: onehaven
  DD_ENV: ci
  DD_TAGS: "repo:${{ github.repository }},branch:${{ github.ref_name }},workflow:${{ github.workflow }}"

jobs:
  backend-tests:
    name: Backend tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./oneHavenProject/backend

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js (backend) + cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: oneHavenProject/backend/package-lock.json

      # Bottleneck span: dependency install
      - name: Install backend dependencies (Datadog traced)
        run: npx -y @datadog/datadog-ci@latest trace --name "backend:npm ci" -- npm ci

      # Bottleneck span: tests
      - name: Run backend tests with coverage (Datadog traced)
        env:
          NODE_ENV: test
        run: npx -y @datadog/datadog-ci@latest trace --name "backend:tests" -- npm test -- --coverage

      # (opcijsko) dodatna metrika za analizo
      - name: Measure backend coverage size (optional)
        run: |
          SIZE=$(du -sk coverage | awk '{print $1}')
          npx -y @datadog/datadog-ci@latest measure --level job --measures "backend.coverage_kb:${SIZE}"

      - name: Upload backend coverage report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: oneHavenProject/backend/coverage

  frontend-tests:
    name: Frontend tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./oneHavenProject/frontend

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js (frontend) + cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: oneHavenProject/frontend/package-lock.json

      - name: Install frontend dependencies (Datadog traced)
        run: npx -y @datadog/datadog-ci@latest trace --name "frontend:npm ci" -- npm ci

      - name: Run frontend tests with coverage (Datadog traced)
        env:
          CI: false
        run: npx -y @datadog/datadog-ci@latest trace --name "frontend:tests" -- npm test -- --watch=false --coverage

      - name: Upload frontend coverage report
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: oneHavenProject/frontend/coverage

  build:
    name: Build (Frontend + Backend artifacts)
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # -------- FRONTEND BUILD --------
      - name: Setup Node.js (frontend) + cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: oneHavenProject/frontend/package-lock.json

      - name: Install frontend dependencies (Datadog traced)
        working-directory: ./oneHavenProject/frontend
        run: npx -y @datadog/datadog-ci@latest trace --name "frontend:npm ci (build job)" -- npm ci

      - name: Build frontend (Datadog traced)
        working-directory: ./oneHavenProject/frontend
        env:
          CI: false
        run: npx -y @datadog/datadog-ci@latest trace --name "frontend:build" -- npm run build

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: oneHavenProject/frontend/build

      # -------- BACKEND "BUILD" ARTEFAKT --------
      - name: Create backend build artifact (package) (Datadog traced)
        run: npx -y @datadog/datadog-ci@latest trace --name "backend:package artifact" -- bash -lc '
          mkdir -p artifacts
          tar -czf artifacts/backend-build.tar.gz -C oneHavenProject/backend .
        '

      - name: Upload backend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: artifacts/backend-build.tar.gz

  sonarcloud:
    name: SonarCloud analiza + Quality Gate (API)
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - name: Checkout repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq (needed for SonarCloud API parsing)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Download backend coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage
          path: oneHavenProject/backend/coverage

      - name: Download frontend coverage artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage
          path: oneHavenProject/frontend/coverage

      - name: SonarCloud scan (Datadog traced)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: npx -y @datadog/datadog-ci@latest trace --name "sonarcloud:scan" -- bash -lc '
          # sonar action je "uses", zato jo poganjamo ločeno:
          echo "Sonar scan runs via GitHub Action step below"
        '

      - name: SonarCloud scan
        uses: SonarSource/sonarcloud-github-action@v3
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Wait for SonarCloud analysis to finish (API) (Datadog traced)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: npx -y @datadog/datadog-ci@latest trace --name "sonarcloud:wait" -- bash -lc '
          CE_TASK_ID=$(cat .scannerwork/report-task.txt | sed -n "s/ceTaskId=//p")
          if [ -z "$CE_TASK_ID" ]; then
            echo "ceTaskId ni najden v .scannerwork/report-task.txt"
            exit 1
          fi

          echo "⏳ Čakam na SonarCloud Compute Engine task: $CE_TASK_ID"

          DONE="false"
          for i in {1..30}; do
            STATUS=$(curl -s -u "${SONAR_TOKEN}:" \
              "https://sonarcloud.io/api/ce/task?id=${CE_TASK_ID}" \
              | jq -r ".task.status")

            echo "➡️  status: $STATUS (poskus $i/30)"

            if [ "$STATUS" = "SUCCESS" ]; then
              echo "Analiza je končana."
              DONE="true"
              break
            fi

            if [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "CANCELED" ]; then
              echo "SonarCloud analiza ni uspela (status=$STATUS)"
              exit 1
            fi

            sleep 10
          done

          if [ "$DONE" != "true" ]; then
            echo "SonarCloud analiza ni končala v predvidenem času."
            exit 1
          fi
        '

      - name: Quality Gate check (API) - fail if not OK (Datadog traced)
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: npx -y @datadog/datadog-ci@latest trace --name "sonarcloud:quality gate" -- bash -lc '
          QG_STATUS=$(curl -s -u "${SONAR_TOKEN}:" \
            "https://sonarcloud.io/api/qualitygates/project_status?projectKey=strasekeva_OneHaven" \
            | jq -r ".projectStatus.status")

          echo "Quality Gate status: $QG_STATUS"

          if [ "$QG_STATUS" != "OK" ]; then
            echo "Quality Gate ni prestan. Ustavim pipeline."
            exit 1
          fi

          echo "Quality Gate prestan."
        '

  docker-dev:
    name: Docker build & push (dev)
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref_name == 'main'
    environment: Development

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend Docker image (dev) (Datadog traced)
        run: npx -y @datadog/datadog-ci@latest trace --name "docker:build+push dev" -- bash -lc '
          docker buildx build \
            --file oneHavenProject/backend/Dockerfile \
            --tag "${{ secrets.DOCKER_USERNAME }}/onehaven-backend:dev" \
            --tag "${{ secrets.DOCKER_USERNAME }}/onehaven-backend:dev-${{ github.sha }}" \
            --push \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            oneHavenProject/backend
        '

  docker-prod:
    name: Docker build & push (prod)
    runs-on: ubuntu-latest
    needs: [build, sonarcloud]
    if: github.event_name == 'push' && github.ref_name == 'production'
    environment: Production

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend Docker image (prod) (Datadog traced)
        run: npx -y @datadog/datadog-ci@latest trace --name "docker:build+push prod" -- bash -lc '
          docker buildx build \
            --file oneHavenProject/backend/Dockerfile \
            --tag "${{ secrets.DOCKER_USERNAME }}/onehaven-backend:prod" \
            --tag "${{ secrets.DOCKER_USERNAME }}/onehaven-backend:prod-${{ github.sha }}" \
            --push \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            oneHavenProject/backend
        '

  deploy-backend-render:
    name: Deploy backend to Render (prod)
    runs-on: ubuntu-latest
    needs: [docker-prod, sonarcloud]
    if: github.event_name == 'push' && github.ref_name == 'production'
    environment: Production

    steps:
      - name: Trigger Render deploy hook (Datadog traced)
        run: npx -y @datadog/datadog-ci@latest trace --name "deploy:render backend" -- bash -lc '
          curl -fsSL -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
        '

      # DORA deployment event (za metrike deployev)
      - name: Datadog DORA deployment event (backend prod)
        run: |
          STARTED_AT=$(date +%s)
          npx -y @datadog/datadog-ci@latest dora deployment \
            --service onehaven-backend \
            --env prod \
            --started-at $STARTED_AT \
            --custom-tags repo:${{ github.repository }} \
            --custom-tags branch:${{ github.ref_name }}

  deploy-frontend:
    name: Deploy frontend to Firebase Hosting
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref_name == 'main'

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js (frontend) + cache
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: oneHavenProject/frontend/package-lock.json

      - name: Install frontend dependencies (Datadog traced)
        working-directory: ./oneHavenProject/frontend
        run: npx -y @datadog/datadog-ci@latest trace --name "frontend:npm ci (deploy job)" -- npm ci

      - name: Build frontend (Datadog traced)
        working-directory: ./oneHavenProject/frontend
        env:
          CI: false
        run: npx -y @datadog/datadog-ci@latest trace --name "frontend:build (deploy job)" -- npm run build

      - name: Install Firebase CLI
        run: npm i -g firebase-tools

      - name: Deploy to Firebase Hosting (Datadog traced)
        working-directory: ./oneHavenProject/frontend
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: npx -y @datadog/datadog-ci@latest trace --name "deploy:firebase frontend" -- firebase deploy --only hosting

      # DORA deployment event (dev)
      - name: Datadog DORA deployment event (frontend dev)
        run: |
          STARTED_AT=$(date +%s)
          npx -y @datadog/datadog-ci@latest dora deployment \
            --service onehaven-frontend \
            --env dev \
            --started-at $STARTED_AT \
            --custom-tags repo:${{ github.repository }} \
            --custom-tags branch:${{ github.ref_name }}

  deploy-pages:
    name: Deploy project page to GitHub Pages
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && github.ref_name == 'main'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4